generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Enumeraciones convertidas a String para compatibilidad con SQLite
// UserRole: ADMIN, CAJA, MATRIZADOR, RECEPCION, ARCHIVO

// Enum de roles para PostgreSQL
enum UserRole {
  ADMIN
  CAJA
  MATRIZADOR
  RECEPCION
  ARCHIVO
}
// DocumentType: PROTOCOLO, DILIGENCIA, ARRENDAMIENTO, CERTIFICACION, OTROS
// DocumentStatus: PENDIENTE, EN_PROCESO, LISTO, ENTREGADO, ANULADO_NOTA_CREDITO
// DocumentEventType: DOCUMENT_CREATED, DOCUMENT_ASSIGNED, STATUS_CHANGED, VERIFICATION_GENERATED, WHATSAPP_SENT, EXTRACTION_SNAPSHOT, EXTRACTION_APPLIED, STATUS_UNDO, NOTE_ADDED, UNKNOWN

// Modelo principal de usuarios
model User {
  id          Int      @id @default(autoincrement())
  email       String   @unique
  password    String
  firstName   String
  lastName    String
  role        UserRole
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastLogin   DateTime?

  // Relaciones con documentos
  documents         Document[] @relation("AssignedDocuments")   // Documentos asignados (matrizador)
  createdDocuments  Document[] @relation("CreatedDocuments")    // Documentos creados (caja)
  deliveredDocuments Document[] @relation("DeliveredDocuments") // Documentos entregados (recepci√≥n)
  
  // Relaci√≥n de auditor√≠a - NUEVA FUNCIONALIDAD
  documentEvents    DocumentEvent[]                            // Eventos de auditor√≠a realizados por el usuario
  concuerdoAudits   ConcuerdoAuditLog[]                        // Auditor√≠a de generaci√≥n de concuerdos
  escriturasQR      EscrituraQR[]                              // Escrituras QR creadas por el usuario
  auditoriaPersonas AuditoriaPersona[]                         // Auditor√≠a de reseteos de PIN de personas
  formularioUAFEAsignaciones FormularioUAFEAsignacion[]        // Formularios UAFE asignados por el matrizador
  protocolosUAFE    ProtocoloUAFE[]                            // Protocolos UAFE creados por el matrizador

  @@map("users")
}

// Modelo de documentos
model Document {
  id                      String         @id @default(uuid())
  protocolNumber          String         @unique   // C√≥digo notarial extra√≠do del XML
  clientName              String                   // Nombre del cliente
  clientPhone             String?                  // CELULAR del cliente para WhatsApp
  clientEmail             String?                  // Email del cliente
  clientId                String?                  // C√©dula, RUC, pasaporte o cualquier ID del cliente
  
  // CAMPOS EDITABLES - Agregados para funcionalidad de edici√≥n
  detalle_documento       String?                  // Descripci√≥n espec√≠fica del tr√°mite
  comentarios_recepcion   String?                  // Notas especiales para recepci√≥n
  
  documentType            String        // Tipo de documento detectado
  status                  String @default("PENDIENTE")
  verificationCode        String?                  // C√≥digo de 4 d√≠gitos para entrega
  
  // Relaciones
  assignedToId            Int?                     // FK al matrizador asignado
  assignedTo              User?          @relation("AssignedDocuments", fields: [assignedToId], references: [id])
  createdById             Int                      // FK al usuario de caja que cre√≥
  createdBy               User           @relation("CreatedDocuments", fields: [createdById], references: [id])
  
  // Informaci√≥n extra√≠da del XML
  actoPrincipalDescripcion String                  // Descripci√≥n del acto principal detectado
  actoPrincipalValor       Float                   // Valor del acto principal
  totalFactura             Float                   // Total de la factura XML
  matrizadorName           String                  // Nombre del matrizador del XML
  itemsSecundarios         String?                   // Array de items ignorados para auditor√≠a (JSON string)
  xmlOriginal              String?                 // XML completo opcional

  // Agrupaci√≥n de documentos
  documentGroupId       String?    // ID del grupo (compartido entre documentos agrupados)
  isGrouped            Boolean @default(false)
  groupLeaderId        String?    // ID del documento "l√≠der" del grupo
  groupPosition        Int?       // Posici√≥n en el grupo (1=l√≠der, 2,3,4...)
  
  // C√≥digo de verificaci√≥n grupal
  groupVerificationCode String?   // MISMO c√≥digo para todos los del grupo
  
  // Estados de agrupaci√≥n
  groupCreatedAt       DateTime?
  groupCreatedBy       String?    // ID del matrizador que cre√≥ el grupo
  
  // Control de entrega grupal
  groupDeliveredAt     DateTime?  // Cuando se entreg√≥ el grupo completo
  groupDeliveredTo     String?    // Quien recibi√≥ el grupo
  individualDelivered  Boolean @default(false) // Si se entreg√≥ individualmente

  // CONFIGURACI√ìN DE NOTIFICACIONES
  notificationPolicy   String  @default("automatica") // "automatica", "no_notificar", "entrega_inmediata"

  // CAMPOS ESPEC√çFICOS DE RECEPCI√ìN
  codigoRetiro         String?    // C√≥digo de 4 d√≠gitos para retiro (individual o grupal)
  entregadoA           String?    // Nombre de quien retira el documento
  cedulaReceptor       String?    // C√©dula/Pasaporte de quien retira (opcional)
  relacionTitular      String?    // Relaci√≥n con titular: titular, abogado, empleado, tercero
  verificacionManual   Boolean @default(false) // Cliente validado sin c√≥digo
  facturaPresenta      Boolean @default(false) // Cliente present√≥ factura de pago
  fechaEntrega         DateTime?  // Fecha y hora de entrega
  usuarioEntregaId     Int?       // ID del usuario de recepci√≥n que entreg√≥
  usuarioEntrega       User?      @relation("DeliveredDocuments", fields: [usuarioEntregaId], references: [id])
  observacionesEntrega String?    // Observaciones adicionales de la entrega

  // Nota de cr√©dito (anulaci√≥n)
  notaCreditoMotivo       String?          // Motivo obligatorio al aplicar nota de cr√©dito
  notaCreditoEstadoPrevio String?  // Estado previo para permitir reversi√≥n
  notaCreditoFecha        DateTime?        // Fecha en que se aplic√≥ la nota de cr√©dito

  documentGroup         DocumentGroup? @relation(fields: [documentGroupId], references: [id])
  
  // Relaci√≥n de auditor√≠a - NUEVA FUNCIONALIDAD
  events                DocumentEvent[]        // Historial de eventos del documento
  notifications         WhatsAppNotification[] // Notificaciones enviadas para este documento
  concuerdoAudits       ConcuerdoAuditLog[]    // Auditor√≠a de generaci√≥n de concuerdos

  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  
  @@map("documents")
  // √çndices para acelerar listados y filtros comunes
  @@index([status])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([assignedToId])
  @@index([documentGroupId])
  @@index([assignedToId, status])
  @@index([documentGroupId, status])
}

// Modelo para gestionar grupos
model DocumentGroup {
  id                   String @id @default(uuid())
  groupCode           String @unique // C√≥digo √∫nico del grupo
  verificationCode    String @unique // C√≥digo de 4 d√≠gitos compartido
  
  // Informaci√≥n del cliente
  clientName          String
  clientPhone         String
  clientEmail         String?
  
  // Estados del grupo
  status              String @default("IN_PROCESS") // IN_PROCESS, READY, DELIVERED
  documentsCount      Int
  
  // Control de notificaciones
  notificationSent    Boolean @default(false)
  notificationSentAt  DateTime?
  
  // Metadatos
  createdBy           String    // ID del matrizador
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relaci√≥n con documentos
  documents          Document[]
  notifications      WhatsAppNotification[]
}

// enum GroupStatus (SQLite compatible)

// MODELO DE AUDITOR√çA - Registro de eventos de documentos
model DocumentEvent {
  id              String            @id @default(uuid())
  documentId      String                          // FK al documento
  userId          Int                             // FK al usuario que realiz√≥ la acci√≥n
  eventType       String @default("UNKNOWN") // Tipo de evento (string)
  description     String                         // Descripci√≥n del evento
  details         String?                          // Detalles adicionales del evento (JSON string)
  // Detalles enriquecidos de entrega (compatibles hacia atr√°s)
  personaRetiro        String?    // Nombre completo de quien retira
  cedulaRetiro         String?    // C√©dula/identificaci√≥n de quien retira
  metodoVerificacion   String?    // codigo_whatsapp | cedula | telefono | manual
  observacionesRetiro  String?    // Observaciones del retiro
  ipAddress       String?                        // IP desde donde se realiz√≥ la acci√≥n
  userAgent       String?                        // User agent del navegador
  createdAt       DateTime  @default(now())

  // Relaciones
  document        Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id])

  @@map("document_events")
  // √çndices para timelines por documento y auditor√≠a por usuario
  @@index([documentId, createdAt])
  @@index([userId])
  @@index([eventType])
}

// Tipos de eventos para auditor√≠a (SQLite compatible)

// Modelo para historial de notificaciones WhatsApp
model WhatsAppNotification {
  id            String              @id @default(uuid())
  documentId    String?                                 // FK al documento (opcional para notificaciones grupales)
  groupId       String?                                 // FK al grupo (opcional)
  clientName    String                                  // Nombre del cliente
  clientPhone   String                                  // N√∫mero de tel√©fono
  messageType   String                       // Tipo de notificaci√≥n
  messageBody   String                                  // Contenido del mensaje
  status        String  @default("PENDING")  // Estado de la notificaci√≥n
  messageId     String?                                 // ID del mensaje de Twilio (si se envi√≥)
  errorMessage  String?                                 // Error si fall√≥
  sentAt        DateTime?                               // Fecha de env√≠o exitoso
  createdAt     DateTime            @default(now())
  
  // Relaciones opcionales
  document      Document?  @relation(fields: [documentId], references: [id])
  group         DocumentGroup? @relation(fields: [groupId], references: [id])
  
  @@map("whatsapp_notifications")
  // √çndices para m√©tricas y b√∫squedas
  @@index([status])
  @@index([documentId])
  @@index([groupId])
  @@index([createdAt])
}

// Tipos de notificaci√≥n (SQLite compatible)
// Estados de notificaci√≥n (SQLite compatible)

// Modelo para templates WhatsApp personalizables por admin
model WhatsAppTemplate {
  id        String              @id @default(uuid())
  tipo      String        // Tipo de template
  titulo    String              // T√≠tulo descriptivo para el admin
  mensaje   String              // Contenido del mensaje con variables {cliente}, {documento}, etc.
  activo    Boolean             @default(true)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  
  @@map("whatsapp_templates")
}

// Tipos de templates disponibles (SQLite compatible)

// Modelo b√°sico para verificar conexi√≥n
model TestConnection {
  id        Int      @id @default(autoincrement())
  message   String   @default("Conexi√≥n exitosa")
  createdAt DateTime @default(now())
  
  @@map("test_connection")
}

// Configuraci√≥n del sistema (clave-valor) para toggles administrables
model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@map("system_settings")
  @@index([key])
}

// MODELO DE AUDITOR√çA PARA CONCUERDOS - T10 Hardening
model ConcuerdoAuditLog {
  id              String   @id @default(uuid())
  docId           String?  // FK opcional al documento fuente
  estructura      String   // "A"|"B"|"C"
  templateMode    String   // "structural"|"family"
  force           String   // "auto"|"A"|"B"|"C"
  hashConcuerdo   String   // SHA-256 de PRIMERA+SEGUNDA
  createdBy       Int      // FK al usuario que gener√≥
  createdAt       DateTime @default(now())
  meta            String?    // JSON con m√©tricas, warnings, versi√≥n plantilla, timings

  // Relaciones
  user            User     @relation(fields: [createdBy], references: [id])
  document        Document? @relation(fields: [docId], references: [id])

  @@map("concuerdo_audit_logs")
  @@index([docId])
  @@index([createdBy])
  @@index([createdAt])
  @@index([estructura])
}

// MODELO PARA ESCRITURAS QR - M√≥dulo de verificaci√≥n de escrituras notariales
model EscrituraQR {
  id                      Int      @id @default(autoincrement())
  token                   String   @unique // Token √∫nico de 8 caracteres alfanum√©ricos
  numeroEscritura         String?  // N√∫mero de escritura extra√≠do (ej: "20251701018P02183")
  datosCompletos          String?  // JSON con todos los datos extra√≠dos del PDF
  archivoOriginal         String?  // Nombre del archivo PDF original
  extractoTextoCompleto   String?  @db.Text // Texto completo del extracto (opcional, para consulta)
  fotoURL                 String?  // URL p√∫blica de la foto (opcional)
  origenDatos             String   @default("PDF") // "PDF" | "MANUAL" - c√≥mo se ingres√≥
  estado                  String   @default("activo") // "activo", "revision_requerida", "inactivo"
  activo                  Boolean  @default(true) // Flag de activaci√≥n/desactivaci√≥n
  createdBy               Int?     // FK al usuario matrizador que cre√≥ la escritura
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  // Campos para PDF completo (verificaci√≥n p√∫blica)
  pdfFileName             String?  // Nombre del archivo PDF en FTP (TOKEN.pdf)
  pdfUploadedAt           DateTime? // Fecha de subida del PDF
  pdfUploadedBy           Int?     // ID del usuario que subi√≥ el PDF
  pdfFileSize             Int?     // Tama√±o del archivo en bytes
  pdfViewCount            Int      @default(0) // Contador de visualizaciones p√∫blicas
  pdfHiddenPages          String?  // Array JSON de p√°ginas ocultas (ej: "[2,5,7]") por privacidad

  // Relaciones
  creador                 User?    @relation(fields: [createdBy], references: [id])

  @@map("escrituras_qr")
  // √çndices para performance
  @@index([token])
  @@index([estado])
  @@index([createdAt])
  @@index([createdBy])
  @@index([origenDatos])
}

// ============================================================================
// SISTEMA DE PERSONAS - AUTENTICACI√ìN CON PIN (SUBSISTEMA 1)
// ============================================================================

// Modelo principal de personas registradas con PIN
model PersonaRegistrada {
  id                    String   @id @default(uuid())
  numeroIdentificacion  String   @unique
  tipoPersona           String   // "NATURAL" o "JURIDICA"

  // üîê AUTENTICACI√ìN
  pinHash               String   // Hash bcrypt del PIN (NUNCA el PIN en texto plano)
  pinCreado             Boolean  @default(false)
  pinResetCount         Int      @default(0)  // Contador de veces que se reseteo

  // üõ°Ô∏è SEGURIDAD
  intentosFallidos      Int      @default(0)
  bloqueadoHasta        DateTime? // NULL = no bloqueado, DateTime = bloqueado hasta...
  ultimoAcceso          DateTime?
  ultimoIntentoFallido  DateTime?

  // üìÑ DATOS DEL FORMULARIO UAFE
  // JSON porque P. Natural y P. Jur√≠dica tienen estructuras MUY diferentes
  datosPersonaNatural   Json?
  datosPersonaJuridica  Json?
  completado            Boolean  @default(false)  // true = formulario completo

  // üìÖ METADATA
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // üîó RELACIONES
  sesiones              SesionPersonal[]
  auditoria             AuditoriaPersona[]
  formularioAsignaciones FormularioUAFEAsignacion[]
  formularioRespuestas  FormularioUAFERespuesta[]
  protocolos            PersonaProtocolo[]                     // Protocolos en los que participa esta persona

  @@map("personas_registradas")
  @@index([numeroIdentificacion])  // B√∫squeda r√°pida por c√©dula
  @@index([bloqueadoHasta])         // Consulta eficiente de bloqueados
}

// Modelo para gestionar sesiones temporales de personas
model SesionPersonal {
  id              String   @id @default(uuid())
  personaId       String
  token           String   @unique  // Token de sesi√≥n (UUID)

  // ‚è∞ EXPIRACI√ìN
  expiraEn        DateTime  // Timestamp absoluto de expiraci√≥n
  ultimaActividad DateTime @default(now())  // Se actualiza en cada request

  // üåê TRACKING (para auditor√≠a y seguridad)
  ipAddress       String?
  userAgent       String?

  createdAt       DateTime @default(now())

  // üîó RELACI√ìN
  persona         PersonaRegistrada @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@map("sesiones_personales")
  @@index([token])       // B√∫squeda ultra-r√°pida por token
  @@index([personaId])   // Ver sesiones de una persona
  @@index([expiraEn])    // Cleanup de sesiones expiradas
}

// Modelo para auditor√≠a de acciones de personas
model AuditoriaPersona {
  id              String   @id @default(uuid())
  personaId       String

  // üìù EVENTO
  tipo            String   // "REGISTRO", "LOGIN", "PIN_FALLIDO", "PIN_RESET", "BLOQUEO", "DESBLOQUEO", "ACTUALIZACION"
  descripcion     String   // Descripci√≥n legible del evento

  // üë§ RESPONSABLE
  matrizadorId    Int?     // NULL = acci√≥n del propio usuario, INT = matrizador que hizo el reseteo
  matrizador      User?    @relation(fields: [matrizadorId], references: [id])

  // üåê TRACKING
  ipAddress       String?
  userAgent       String?

  createdAt       DateTime @default(now())

  // üîó RELACI√ìN
  persona         PersonaRegistrada @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@map("auditoria_personas")
  @@index([personaId])    // Historial de una persona
  @@index([tipo])         // Filtrar por tipo de evento
  @@index([createdAt])    // Orden cronol√≥gico
}

// ============================================================================
// SISTEMA DE FORMULARIOS UAFE - MATRIZADOR (SUBSISTEMA 2)
// ============================================================================

// Asignaci√≥n de formulario UAFE a una persona espec√≠fica
model FormularioUAFEAsignacion {
  id                String   @id @default(uuid())

  // üéØ ASIGNACI√ìN
  personaId         String
  persona           PersonaRegistrada @relation(fields: [personaId], references: [id], onDelete: Cascade)

  // üìã INFORMACI√ìN DEL TR√ÅMITE
  numeroMatriz      String   // No. Matriz
  actoContrato      String   // Acto / Contrato Diligencia

  // üë§ CALIDAD EN EL ACTO
  calidadPersona    String   // "COMPRADOR" | "VENDEDOR" | "OTRO"
  actuaPor          String   // "PROPIOS_DERECHOS" | "REPRESENTANDO_A"

  // üîó LINK √öNICO Y ESTADO
  token             String   @unique  // Token √∫nico para acceder al formulario
  estado            String   @default("PENDIENTE")  // "PENDIENTE" | "COMPLETADO" | "EXPIRADO"
  expiraEn          DateTime?  // Opcional: fecha de expiraci√≥n

  // üë§ MATRIZADOR RESPONSABLE
  matrizadorId      Int
  matrizador        User     @relation(fields: [matrizadorId], references: [id])

  // üìù RESPUESTA (cuando se complete)
  respuestaId       String?  @unique
  respuesta         FormularioUAFERespuesta? @relation(fields: [respuestaId], references: [id])

  // üìÖ METADATA
  createdAt         DateTime @default(now())
  completadoEn      DateTime?

  @@map("formulario_uafe_asignaciones")
  @@index([token])
  @@index([personaId])
  @@index([matrizadorId])
  @@index([estado])
  @@index([numeroMatriz])
}

// Respuesta completa de un formulario UAFE
model FormularioUAFERespuesta {
  id                String   @id @default(uuid())

  asignacionId      String   @unique
  asignacion        FormularioUAFEAsignacion?

  personaId         String
  persona           PersonaRegistrada @relation(fields: [personaId], references: [id], onDelete: Cascade)

  // =====================================================
  // SECCI√ìN 1: INFORMACI√ìN DEL TR√ÅMITE
  // =====================================================
  fecha             DateTime
  numeroMatriz      String
  actoContrato      String
  avaluoMunicipal   Float?
  valorContrato     Float?

  // Forma de Pago
  formaPagoCheque   Boolean  @default(false)
  formaPagoEfectivo Boolean  @default(false)
  formaPagoTransferencia Boolean @default(false)
  formaPagoTarjeta  Boolean  @default(false)
  montoCheque       Float?
  montoEfectivo     Float?
  montoTransferencia Float?
  montoTarjeta      Float?
  bancoCheque       String?
  bancoTransferencia String?
  bancoTarjeta      String?

  // =====================================================
  // SECCI√ìN 2: PERSONA QUE REALIZA EL ACTO
  // =====================================================
  calidad           String   // "COMPRADOR" | "VENDEDOR"
  actuaPor          String   // "PROPIOS_DERECHOS" | "REPRESENTANDO_A"

  // Tipo de Identificaci√≥n (usa los datos de PersonaRegistrada)
  tipoIdentificacion String  // "CEDULA" | "RUC" | "PASAPORTE"
  numeroIdentificacion String
  nacionalidad      String
  estadoCivil       String   // "SOLTERO" | "CASADO" | "UNION_LIBRE" | "DIVORCIADO" | "VIUDO" | "DISOLUCION_SOCIEDAD"
  genero            String   // "MASCULINO" | "FEMENINO"
  nivelEstudio      String   // "BACHILLER" | "UNIVERSITARIO" | "MAESTRIA" | "POSTGRADO"

  // Direcci√≥n
  callePrincipal    String
  numeroDomicilio   String?
  calleSecundaria   String?

  // =====================================================
  // SECCI√ìN 3: INFORMACI√ìN LABORAL
  // =====================================================
  situacionLaboral  String   // "PUBLICO" | "PRIVADO" | "JUBILADO" | "NO_APLICA"
  relacionDependencia Boolean?
  nombreEntidad     String?
  fechaIngreso      DateTime?
  direccionLaboral  String?
  provinciaLaboral  String?
  cantonLaboral     String?
  profesionOcupacion String?
  cargo             String?
  ingresoMensual    Float?

  // =====================================================
  // SECCI√ìN 4: DATOS DEL C√ìNYUGE (si aplica)
  // =====================================================
  tieneConyugue     Boolean  @default(false)
  conyugeApellidos  String?
  conyugeNombres    String?
  conyugeTipoId     String?  // "CEDULA" | "RUC" | "PASAPORTE"
  conyugeNumeroId   String?
  conyugeNacionalidad String?
  conyugeEstadoCivil String?
  conyugeGenero     String?
  conyugeNivelEstudio String?
  conyugeCorreo     String?
  conyugeCelular    String?
  conyugeCallePrincipal String?
  conyugeNumero     String?
  conyugeCalleSecundaria String?
  conyugeProfesion  String?

  // Informaci√≥n laboral del c√≥nyuge
  conyugeSituacionLaboral String?
  conyugeRelacionDependencia Boolean?
  conyugeNombreEntidad String?
  conyugeFechaIngreso DateTime?
  conyugeDireccionLaboral String?
  conyugeProvinciaLaboral String?
  conyugeCantonLaboral String?

  // =====================================================
  // SECCI√ìN 5: BENEFICIARIO FINAL / APODERADO (si aplica)
  // =====================================================
  tieneBeneficiario Boolean  @default(false)
  beneficiarioApellidos String?
  beneficiarioNombres String?
  beneficiarioTipoId String?
  beneficiarioNumeroId String?
  beneficiarioNacionalidad String?
  beneficiarioEstadoCivil String?
  beneficiarioGenero String?
  beneficiarioNivelEstudio String?
  beneficiarioProfesion String?
  beneficiarioDireccion String?
  beneficiarioCorreo String?
  beneficiarioTelefono String?
  beneficiarioCelular String?

  // =====================================================
  // SECCI√ìN 6: PERSONAS EXPUESTAS POL√çTICAMENTE (PEP)
  // =====================================================
  esPEP             Boolean  @default(false)
  esFamiliarPEP     Boolean  @default(false)
  relacionPEP       String?  // "CONYUGE" | "PADRE_MADRE" | "HIJO" | "ABUELO" | "HERMANO" | "NIETO" | "SUEGRO" | "CU√ëADO"
  esColaboradorPEP  Boolean  @default(false)
  tipoColaborador   String?  // "ASISTENTE" | "ASESOR" | "OTRA_PERSONA_CONFIANZA"

  // =====================================================
  // METADATA
  // =====================================================
  completadoEn      DateTime @default(now())
  ipAddress         String?
  userAgent         String?

  @@map("formulario_uafe_respuestas")
  @@index([personaId])
  @@index([asignacionId])
  @@index([numeroMatriz])
  @@index([completadoEn])
}

// ============================================================================
// SISTEMA DE PROTOCOLOS UAFE - NUEVO FLUJO (Protocolo + C√©dula + PIN)
// ============================================================================

// Modelo de Protocolo UAFE (informaci√≥n del tr√°mite)
model ProtocoloUAFE {
  id                    String   @id @default(uuid())
  numeroProtocolo       String   @unique

  // DATOS DEL TR√ÅMITE (llenados por matrizador UNA SOLA VEZ)
  fecha                 DateTime
  actoContrato          String
  avaluoMunicipal       Decimal? @db.Decimal(12, 2)
  valorContrato         Decimal  @db.Decimal(12, 2)

  // FORMA DE PAGO (JSON para flexibilidad)
  formaPago             Json     // { cheque: { monto, banco }, efectivo: { monto }, ... }

  // METADATA
  createdBy             Int
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // RELACIONES
  creador               User     @relation(fields: [createdBy], references: [id])
  personas              PersonaProtocolo[]

  @@map("protocolos_uafe")
  @@index([numeroProtocolo])
  @@index([createdBy])
  @@index([createdAt])
}

// Modelo de PersonaProtocolo (relaci√≥n N:N entre personas y protocolos)
model PersonaProtocolo {
  id                    String   @id @default(uuid())
  protocoloId           String
  personaCedula         String

  // ROL EN ESTE TR√ÅMITE
  calidad               String   // "COMPRADOR", "VENDEDOR", "TESTIGO"
  actuaPor              String   // "PROPIOS_DERECHOS", "REPRESENTANDO"

  // ESTADO
  completado            Boolean  @default(false)
  completadoAt          DateTime?

  // RESPUESTA DEL FORMULARIO (cuando completa)
  respuestaFormulario   Json?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // RELACIONES
  protocolo             ProtocoloUAFE      @relation(fields: [protocoloId], references: [id], onDelete: Cascade)
  persona               PersonaRegistrada  @relation(fields: [personaCedula], references: [numeroIdentificacion])
  sesiones              SesionFormularioUAFE[]

  @@unique([protocoloId, personaCedula])
  @@map("personas_protocolo")
  @@index([protocoloId])
  @@index([personaCedula])
  @@index([completado])
}

// Modelo de Sesi√≥n de Formulario UAFE (sesiones temporales)
model SesionFormularioUAFE {
  id                    String   @id @default(uuid())
  personaProtocoloId    String
  token                 String   @unique

  expiraEn              DateTime
  ultimaActividad       DateTime @default(now())

  ipAddress             String?
  userAgent             String?

  createdAt             DateTime @default(now())

  personaProtocolo      PersonaProtocolo @relation(fields: [personaProtocoloId], references: [id], onDelete: Cascade)

  @@map("sesiones_formulario_uafe")
  @@index([token])
  @@index([personaProtocoloId])
  @@index([expiraEn])
}