generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         Int                        @id @default(autoincrement())
  email                      String                     @unique
  password                   String
  firstName                  String
  lastName                   String
  role                       UserRole
  isActive                   Boolean                    @default(true)
  createdAt                  DateTime                   @default(now())
  updatedAt                  DateTime                   @updatedAt
  lastLogin                  DateTime?
  auditoriaPersonas          AuditoriaPersona[]
  documentEvents             DocumentEvent[]
  documents                  Document[]                 @relation("AssignedDocuments")
  createdDocuments           Document[]                 @relation("CreatedDocuments")
  deliveredDocuments         Document[]                 @relation("DeliveredDocuments")
  escriturasQR               EscrituraQR[]
  formularioUAFEAsignaciones FormularioUAFEAsignacion[]
  protocolosUAFE             ProtocoloUAFE[]

  @@map("users")
}

model Document {
  id                       String                 @id @default(uuid())
  protocolNumber           String                 @unique
  clientName               String
  clientPhone              String?
  clientEmail              String?
  clientId                 String?
  detalle_documento        String?
  comentarios_recepcion    String?
  documentType             String
  status                   String                 @default("PENDIENTE")
  verificationCode         String?
  assignedToId             Int?
  createdById              Int
  actoPrincipalDescripcion String
  actoPrincipalValor       Float
  totalFactura             Float
  matrizadorName           String
  itemsSecundarios         String?
  xmlOriginal              String?
  documentGroupId          String?
  isGrouped                Boolean                @default(false)
  groupLeaderId            String?
  groupPosition            Int?
  groupVerificationCode    String?
  groupCreatedAt           DateTime?
  groupCreatedBy           String?
  groupDeliveredAt         DateTime?
  groupDeliveredTo         String?
  individualDelivered      Boolean                @default(false)
  notificationPolicy       String                 @default("automatica")
  codigoRetiro             String?
  entregadoA               String?
  cedulaReceptor           String?
  relacionTitular          String?
  verificacionManual       Boolean                @default(false)
  facturaPresenta          Boolean                @default(false)
  fechaEntrega             DateTime?
  usuarioEntregaId         Int?
  observacionesEntrega     String?
  notaCreditoMotivo        String?
  notaCreditoEstadoPrevio  String?
  notaCreditoFecha         DateTime?
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @updatedAt
  fechaFactura             DateTime?
  events                   DocumentEvent[]
  assignedTo               User?                  @relation("AssignedDocuments", fields: [assignedToId], references: [id])
  createdBy                User                   @relation("CreatedDocuments", fields: [createdById], references: [id])
  documentGroup            DocumentGroup?         @relation(fields: [documentGroupId], references: [id])
  usuarioEntrega           User?                  @relation("DeliveredDocuments", fields: [usuarioEntregaId], references: [id])
  notifications            WhatsAppNotification[]

  @@index([status])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([clientPhone])
  @@index([clientName])
  @@index([documentGroupId])
  @@index([assignedToId, status])
  @@index([documentGroupId, status])
  @@map("documents")
}

model DocumentGroup {
  id                 String                 @id @default(uuid())
  groupCode          String                 @unique
  verificationCode   String                 @unique
  clientName         String
  clientPhone        String
  clientEmail        String?
  status             String                 @default("IN_PROCESS")
  documentsCount     Int
  notificationSent   Boolean                @default(false)
  notificationSentAt DateTime?
  createdBy          String
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  documents          Document[]
  notifications      WhatsAppNotification[]
}

model DocumentEvent {
  id                  String    @id @default(uuid())
  documentId          String?
  userId              Int
  eventType           String    @default("UNKNOWN")
  description         String
  details             String?
  personaRetiro       String?
  cedulaRetiro        String?
  metodoVerificacion  String?
  observacionesRetiro String?
  ipAddress           String?
  userAgent           String?
  createdAt           DateTime  @default(now())
  document            Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user                User      @relation(fields: [userId], references: [id])

  @@index([documentId, createdAt])
  @@index([userId])
  @@index([eventType])
  @@map("document_events")
}

model WhatsAppNotification {
  id           String         @id @default(uuid())
  documentId   String?
  groupId      String?
  clientName   String
  clientPhone  String
  messageType  String
  messageBody  String
  status       String         @default("PENDING")
  messageId    String?
  errorMessage String?
  sentAt       DateTime?
  createdAt    DateTime       @default(now())
  document     Document?      @relation(fields: [documentId], references: [id])
  group        DocumentGroup? @relation(fields: [groupId], references: [id])

  @@index([status])
  @@index([documentId])
  @@index([groupId])
  @@index([createdAt])
  @@map("whatsapp_notifications")
}

model WhatsAppTemplate {
  id        String   @id @default(uuid())
  tipo      String
  titulo    String
  mensaje   String
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("whatsapp_templates")
}

model TestConnection {
  id        Int      @id @default(autoincrement())
  message   String   @default("Conexi√≥n exitosa")
  createdAt DateTime @default(now())

  @@map("test_connection")
}

model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@index([key])
  @@map("system_settings")
}

model EscrituraQR {
  id                    Int       @id @default(autoincrement())
  token                 String    @unique
  numeroEscritura       String?
  datosCompletos        String?
  archivoOriginal       String?
  estado                String    @default("activo")
  activo                Boolean   @default(true)
  createdBy             Int?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  extractoTextoCompleto String?
  origenDatos           String    @default("PDF")
  fotoURL               String?
  pdfFileName           String?
  pdfUploadedAt         DateTime?
  pdfUploadedBy         Int?
  pdfFileSize           Int?
  pdfViewCount          Int       @default(0)
  pdfHiddenPages        String?
  creador               User?     @relation(fields: [createdBy], references: [id])

  @@index([token])
  @@index([estado])
  @@index([createdAt])
  @@index([createdBy])
  @@index([origenDatos])
  @@map("escrituras_qr")
}

model PersonaRegistrada {
  id                         String                     @id @default(uuid())
  numeroIdentificacion       String                     @unique
  tipoPersona                String
  pinHash                    String
  pinCreado                  Boolean                    @default(false)
  pinResetCount              Int                        @default(0)
  intentosFallidos           Int                        @default(0)
  bloqueadoHasta             DateTime?
  ultimoAcceso               DateTime?
  ultimoIntentoFallido       DateTime?
  datosPersonaNatural        Json?
  datosPersonaJuridica       Json?
  completado                 Boolean                    @default(false)
  createdAt                  DateTime                   @default(now())
  updatedAt                  DateTime                   @updatedAt
  auditoria                  AuditoriaPersona[]
  formularioAsignaciones     FormularioUAFEAsignacion[]
  formularioRespuestas       FormularioUAFERespuesta[]
  protocolos                 PersonaProtocolo[]         @relation("Compareciente")
  protocolosComoRepresentado PersonaProtocolo[]         @relation("Representado")
  sesiones                   SesionPersonal[]

  @@index([numeroIdentificacion])
  @@index([bloqueadoHasta])
  @@map("personas_registradas")
}

model SesionPersonal {
  id              String            @id @default(uuid())
  personaId       String
  token           String            @unique
  expiraEn        DateTime
  ultimaActividad DateTime          @default(now())
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime          @default(now())
  persona         PersonaRegistrada @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([personaId])
  @@index([expiraEn])
  @@map("sesiones_personales")
}

model AuditoriaPersona {
  id           String            @id @default(uuid())
  personaId    String
  tipo         String
  descripcion  String
  matrizadorId Int?
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime          @default(now())
  matrizador   User?             @relation(fields: [matrizadorId], references: [id])
  persona      PersonaRegistrada @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@index([personaId])
  @@index([tipo])
  @@index([createdAt])
  @@map("auditoria_personas")
}

model FormularioUAFEAsignacion {
  id             String                   @id @default(uuid())
  personaId      String
  numeroMatriz   String
  actoContrato   String
  calidadPersona String
  actuaPor       String
  token          String                   @unique
  estado         String                   @default("PENDIENTE")
  expiraEn       DateTime?
  matrizadorId   Int
  respuestaId    String?                  @unique
  createdAt      DateTime                 @default(now())
  completadoEn   DateTime?
  matrizador     User                     @relation(fields: [matrizadorId], references: [id])
  persona        PersonaRegistrada        @relation(fields: [personaId], references: [id], onDelete: Cascade)
  respuesta      FormularioUAFERespuesta? @relation(fields: [respuestaId], references: [id])

  @@index([token])
  @@index([personaId])
  @@index([matrizadorId])
  @@index([estado])
  @@index([numeroMatriz])
  @@map("formulario_uafe_asignaciones")
}

model FormularioUAFERespuesta {
  id                         String                    @id @default(uuid())
  asignacionId               String                    @unique
  personaId                  String
  fecha                      DateTime
  numeroMatriz               String
  actoContrato               String
  avaluoMunicipal            Float?
  valorContrato              Float?
  formaPagoCheque            Boolean                   @default(false)
  formaPagoEfectivo          Boolean                   @default(false)
  formaPagoTransferencia     Boolean                   @default(false)
  formaPagoTarjeta           Boolean                   @default(false)
  montoCheque                Float?
  montoEfectivo              Float?
  montoTransferencia         Float?
  montoTarjeta               Float?
  bancoCheque                String?
  bancoTransferencia         String?
  bancoTarjeta               String?
  calidad                    String
  actuaPor                   String
  tipoIdentificacion         String
  numeroIdentificacion       String
  nacionalidad               String
  estadoCivil                String
  genero                     String
  nivelEstudio               String
  callePrincipal             String
  numeroDomicilio            String?
  calleSecundaria            String?
  situacionLaboral           String
  relacionDependencia        Boolean?
  nombreEntidad              String?
  fechaIngreso               DateTime?
  direccionLaboral           String?
  provinciaLaboral           String?
  cantonLaboral              String?
  profesionOcupacion         String?
  cargo                      String?
  ingresoMensual             Float?
  tieneConyugue              Boolean                   @default(false)
  conyugeApellidos           String?
  conyugeNombres             String?
  conyugeTipoId              String?
  conyugeNumeroId            String?
  conyugeNacionalidad        String?
  conyugeEstadoCivil         String?
  conyugeGenero              String?
  conyugeNivelEstudio        String?
  conyugeCorreo              String?
  conyugeCelular             String?
  conyugeCallePrincipal      String?
  conyugeNumero              String?
  conyugeCalleSecundaria     String?
  conyugeProfesion           String?
  conyugeSituacionLaboral    String?
  conyugeRelacionDependencia Boolean?
  conyugeNombreEntidad       String?
  conyugeFechaIngreso        DateTime?
  conyugeDireccionLaboral    String?
  conyugeProvinciaLaboral    String?
  conyugeCantonLaboral       String?
  tieneBeneficiario          Boolean                   @default(false)
  beneficiarioApellidos      String?
  beneficiarioNombres        String?
  beneficiarioTipoId         String?
  beneficiarioNumeroId       String?
  beneficiarioNacionalidad   String?
  beneficiarioEstadoCivil    String?
  beneficiarioGenero         String?
  beneficiarioNivelEstudio   String?
  beneficiarioProfesion      String?
  beneficiarioDireccion      String?
  beneficiarioCorreo         String?
  beneficiarioTelefono       String?
  beneficiarioCelular        String?
  esPEP                      Boolean                   @default(false)
  esFamiliarPEP              Boolean                   @default(false)
  relacionPEP                String?
  esColaboradorPEP           Boolean                   @default(false)
  tipoColaborador            String?
  completadoEn               DateTime                  @default(now())
  ipAddress                  String?
  userAgent                  String?
  asignacion                 FormularioUAFEAsignacion?
  persona                    PersonaRegistrada         @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@index([personaId])
  @@index([asignacionId])
  @@index([numeroMatriz])
  @@index([completadoEn])
  @@map("formulario_uafe_respuestas")
}

model ProtocoloUAFE {
  id                      String             @id @default(uuid())
  numeroProtocolo         String             @unique
  fecha                   DateTime
  actoContrato            String
  avaluoMunicipal         Decimal?           @db.Decimal(12, 2)
  valorContrato           Decimal            @db.Decimal(12, 2)
  createdBy               Int
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  formasPago              Json?
  bienInmuebleDescripcion String?
  bienInmuebleUbicacion   String?
  tipoActoOtro            String?
  vehiculoAnio            String?
  vehiculoMarca           String?
  vehiculoModelo          String?
  vehiculoPlaca           String?
  personas                PersonaProtocolo[]
  creador                 User               @relation(fields: [createdBy], references: [id])

  @@index([numeroProtocolo])
  @@index([createdBy])
  @@index([createdAt])
  @@map("protocolos_uafe")
}

model PersonaProtocolo {
  id                  String                 @id @default(uuid())
  protocoloId         String
  personaCedula       String
  calidad             String
  actuaPor            String
  completado          Boolean                @default(false)
  completadoAt        DateTime?
  respuestaFormulario Json?
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  representadoId      String?
  datosRepresentado   Json?
  persona             PersonaRegistrada      @relation("Compareciente", fields: [personaCedula], references: [numeroIdentificacion])
  protocolo           ProtocoloUAFE          @relation(fields: [protocoloId], references: [id], onDelete: Cascade)
  representado        PersonaRegistrada?     @relation("Representado", fields: [representadoId], references: [numeroIdentificacion])
  sesiones            SesionFormularioUAFE[]

  @@unique([protocoloId, personaCedula])
  @@index([protocoloId])
  @@index([personaCedula])
  @@index([completado])
  @@index([representadoId])
  @@map("personas_protocolo")
}

model SesionFormularioUAFE {
  id                 String           @id @default(uuid())
  personaProtocoloId String
  token              String           @unique
  expiraEn           DateTime
  ultimaActividad    DateTime         @default(now())
  ipAddress          String?
  userAgent          String?
  createdAt          DateTime         @default(now())
  personaProtocolo   PersonaProtocolo @relation(fields: [personaProtocoloId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([personaProtocoloId])
  @@index([expiraEn])
  @@map("sesiones_formulario_uafe")
}

enum UserRole {
  ADMIN
  CAJA
  MATRIZADOR
  RECEPCION
  ARCHIVO
}
