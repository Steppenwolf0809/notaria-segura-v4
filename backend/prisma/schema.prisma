generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         Int                        @id @default(autoincrement())
  email                      String                     @unique
  password                   String
  firstName                  String
  lastName                   String
  role                       UserRole
  isActive                   Boolean                    @default(true)
  createdAt                  DateTime                   @default(now())
  updatedAt                  DateTime                   @updatedAt
  lastLogin                  DateTime?
  auditoriaPersonas          AuditoriaPersona[]
  documentEvents             DocumentEvent[]
  documents                  Document[]                 @relation("AssignedDocuments")
  createdDocuments           Document[]                 @relation("CreatedDocuments")
  deliveredDocuments         Document[]                 @relation("DeliveredDocuments")
  escriturasQR               EscrituraQR[]
  formularioUAFEAsignaciones FormularioUAFEAsignacion[]
  protocolosUAFE             ProtocoloUAFE[]
  importLogs                 ImportLog[]

  @@map("users")
}

model Document {
  id                       String                 @id @default(uuid())
  protocolNumber           String                 @unique
  clientName               String
  clientPhone              String?
  clientEmail              String?
  clientId                 String?
  detalle_documento        String?
  comentarios_recepcion    String?
  documentType             String
  status                   String                 @default("PENDIENTE")
  verificationCode         String?
  assignedToId             Int?
  createdById              Int
  actoPrincipalDescripcion String
  actoPrincipalValor       Float
  totalFactura             Float
  matrizadorName           String
  itemsSecundarios         String?
  xmlOriginal              String?
  numeroFactura            String?   // N煤mero de factura del SRI (formato: 001-002-000123676)
  codigoRetiro             String?
  entregadoA               String?
  cedulaReceptor           String?
  relacionTitular          String?
  verificacionManual       Boolean                @default(false)
  facturaPresenta          Boolean                @default(false)
  fechaEntrega             DateTime?
  usuarioEntregaId         Int?
  observacionesEntrega     String?
  notaCreditoMotivo        String?
  notaCreditoEstadoPrevio  String?
  notaCreditoFecha         DateTime?
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @updatedAt
  fechaFactura             DateTime?
  
  // Trazabilidad de notificaciones WhatsApp
  fechaListo               DateTime?              // Timestamp al pasar a LISTO
  ultimoRecordatorio       DateTime?              // ltima notificaci贸n enviada
  
  // Gesti贸n interna
  pagoConfirmado           Boolean                @default(false)
  alertaInterna            Boolean                @default(false)
  mensajeInterno           String?
  
  events                   DocumentEvent[]
  assignedTo               User?                  @relation("AssignedDocuments", fields: [assignedToId], references: [id])
  createdBy                User                   @relation("CreatedDocuments", fields: [createdById], references: [id])
  usuarioEntrega           User?                  @relation("DeliveredDocuments", fields: [usuarioEntregaId], references: [id])
  notifications            WhatsAppNotification[]
  invoices                  Invoice[]

  @@index([status])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([clientPhone])
  @@index([clientName])
  @@index([clientId])
  @@index([assignedToId, status])
  @@map("documents")
}

model DocumentEvent {
  id                  String    @id @default(uuid())
  documentId          String?
  userId              Int
  eventType           String    @default("UNKNOWN")
  description         String
  details             String?
  personaRetiro       String?
  cedulaRetiro        String?
  metodoVerificacion  String?
  observacionesRetiro String?
  ipAddress           String?
  userAgent           String?
  createdAt           DateTime  @default(now())
  document            Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user                User      @relation(fields: [userId], references: [id])

  @@index([documentId, createdAt])
  @@index([userId])
  @@index([eventType])
  @@map("document_events")
}

model WhatsAppNotification {
  id           String         @id @default(uuid())
  documentId   String?
  clientName   String
  clientPhone  String
  messageType  String
  messageBody  String
  status       String         @default("PENDING")
  messageId    String?
  errorMessage String?
  sentAt       DateTime?
  createdAt    DateTime       @default(now())
  document     Document?      @relation(fields: [documentId], references: [id])

  @@index([status])
  @@index([documentId])
  @@index([createdAt])
  @@map("whatsapp_notifications")
}

model WhatsAppTemplate {
  id        String   @id @default(uuid())
  tipo      String
  titulo    String
  mensaje   String
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("whatsapp_templates")
}

model TestConnection {
  id        Int      @id @default(autoincrement())
  message   String   @default("Conexi贸n exitosa")
  createdAt DateTime @default(now())

  @@map("test_connection")
}

model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@index([key])
  @@map("system_settings")
}

model EscrituraQR {
  id                    Int       @id @default(autoincrement())
  token                 String    @unique
  numeroEscritura       String?
  datosCompletos        String?
  archivoOriginal       String?
  estado                String    @default("activo")
  activo                Boolean   @default(true)
  createdBy             Int?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  extractoTextoCompleto String?
  origenDatos           String    @default("PDF")
  fotoURL               String?
  pdfFileName           String?
  pdfUploadedAt         DateTime?
  pdfUploadedBy         Int?
  pdfFileSize           Int?
  pdfViewCount          Int       @default(0)
  pdfHiddenPages        String?
  creador               User?     @relation(fields: [createdBy], references: [id])

  @@index([token])
  @@index([estado])
  @@index([createdAt])
  @@index([createdBy])
  @@index([origenDatos])
  @@map("escrituras_qr")
}

model PersonaRegistrada {
  id                         String                     @id @default(uuid())
  numeroIdentificacion       String                     @unique
  tipoPersona                String
  pinHash                    String
  pinCreado                  Boolean                    @default(false)
  pinResetCount              Int                        @default(0)
  intentosFallidos           Int                        @default(0)
  bloqueadoHasta             DateTime?
  ultimoAcceso               DateTime?
  ultimoIntentoFallido       DateTime?
  datosPersonaNatural        Json?
  datosPersonaJuridica       Json?
  completado                 Boolean                    @default(false)
  createdAt                  DateTime                   @default(now())
  updatedAt                  DateTime                   @updatedAt
  auditoria                  AuditoriaPersona[]
  formularioAsignaciones     FormularioUAFEAsignacion[]
  formularioRespuestas       FormularioUAFERespuesta[]
  protocolos                 PersonaProtocolo[]         @relation("Compareciente")
  protocolosComoRepresentado PersonaProtocolo[]         @relation("Representado")
  sesiones                   SesionPersonal[]

  @@index([numeroIdentificacion])
  @@index([bloqueadoHasta])
  @@map("personas_registradas")
}

model SesionPersonal {
  id              String            @id @default(uuid())
  personaId       String
  token           String            @unique
  expiraEn        DateTime
  ultimaActividad DateTime          @default(now())
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime          @default(now())
  persona         PersonaRegistrada @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([personaId])
  @@index([expiraEn])
  @@map("sesiones_personales")
}

model AuditoriaPersona {
  id           String            @id @default(uuid())
  personaId    String
  tipo         String
  descripcion  String
  matrizadorId Int?
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime          @default(now())
  matrizador   User?             @relation(fields: [matrizadorId], references: [id])
  persona      PersonaRegistrada @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@index([personaId])
  @@index([tipo])
  @@index([createdAt])
  @@map("auditoria_personas")
}

model FormularioUAFEAsignacion {
  id             String                   @id @default(uuid())
  personaId      String
  numeroMatriz   String
  actoContrato   String
  calidadPersona String
  actuaPor       String
  token          String                   @unique
  estado         String                   @default("PENDIENTE")
  expiraEn       DateTime?
  matrizadorId   Int
  respuestaId    String?                  @unique
  createdAt      DateTime                 @default(now())
  completadoEn   DateTime?
  matrizador     User                     @relation(fields: [matrizadorId], references: [id])
  persona        PersonaRegistrada        @relation(fields: [personaId], references: [id], onDelete: Cascade)
  respuesta      FormularioUAFERespuesta? @relation(fields: [respuestaId], references: [id])

  @@index([token])
  @@index([personaId])
  @@index([matrizadorId])
  @@index([estado])
  @@index([numeroMatriz])
  @@map("formulario_uafe_asignaciones")
}

model FormularioUAFERespuesta {
  id                         String                    @id @default(uuid())
  asignacionId               String                    @unique
  personaId                  String
  fecha                      DateTime
  numeroMatriz               String
  actoContrato               String
  avaluoMunicipal            Float?
  valorContrato              Float?
  formaPagoCheque            Boolean                   @default(false)
  formaPagoEfectivo          Boolean                   @default(false)
  formaPagoTransferencia     Boolean                   @default(false)
  formaPagoTarjeta           Boolean                   @default(false)
  montoCheque                Float?
  montoEfectivo              Float?
  montoTransferencia         Float?
  montoTarjeta               Float?
  bancoCheque                String?
  bancoTransferencia         String?
  bancoTarjeta               String?
  calidad                    String
  actuaPor                   String
  tipoIdentificacion         String
  numeroIdentificacion       String
  nacionalidad               String
  estadoCivil                String
  genero                     String
  nivelEstudio               String
  callePrincipal             String
  numeroDomicilio            String?
  calleSecundaria            String?
  situacionLaboral           String
  relacionDependencia        Boolean?
  nombreEntidad              String?
  fechaIngreso               DateTime?
  direccionLaboral           String?
  provinciaLaboral           String?
  cantonLaboral              String?
  profesionOcupacion         String?
  cargo                      String?
  ingresoMensual             Float?
  tieneConyugue              Boolean                   @default(false)
  conyugeApellidos           String?
  conyugeNombres             String?
  conyugeTipoId              String?
  conyugeNumeroId            String?
  conyugeNacionalidad        String?
  conyugeEstadoCivil         String?
  conyugeGenero              String?
  conyugeNivelEstudio        String?
  conyugeCorreo              String?
  conyugeCelular             String?
  conyugeCallePrincipal      String?
  conyugeNumero              String?
  conyugeCalleSecundaria     String?
  conyugeProfesion           String?
  conyugeSituacionLaboral    String?
  conyugeRelacionDependencia Boolean?
  conyugeNombreEntidad       String?
  conyugeFechaIngreso        DateTime?
  conyugeDireccionLaboral    String?
  conyugeProvinciaLaboral    String?
  conyugeCantonLaboral       String?
  tieneBeneficiario          Boolean                   @default(false)
  beneficiarioApellidos      String?
  beneficiarioNombres        String?
  beneficiarioTipoId         String?
  beneficiarioNumeroId       String?
  beneficiarioNacionalidad   String?
  beneficiarioEstadoCivil    String?
  beneficiarioGenero         String?
  beneficiarioNivelEstudio   String?
  beneficiarioProfesion      String?
  beneficiarioDireccion      String?
  beneficiarioCorreo         String?
  beneficiarioTelefono       String?
  beneficiarioCelular        String?
  esPEP                      Boolean                   @default(false)
  esFamiliarPEP              Boolean                   @default(false)
  relacionPEP                String?
  esColaboradorPEP           Boolean                   @default(false)
  tipoColaborador            String?
  completadoEn               DateTime                  @default(now())
  ipAddress                  String?
  userAgent                  String?
  asignacion                 FormularioUAFEAsignacion?
  persona                    PersonaRegistrada         @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@index([personaId])
  @@index([asignacionId])
  @@index([numeroMatriz])
  @@index([completadoEn])
  @@map("formulario_uafe_respuestas")
}

model ProtocoloUAFE {
  id                      String             @id @default(uuid())
  
  // IDENTIFICACIN (numeroProtocolo ahora opcional para borradores)
  numeroProtocolo         String?            @unique
  identificadorTemporal   String             @unique @default(uuid())
  
  // TIPO Y FECHA
  fecha                   DateTime
  tipoActo                String             // COMPRAVENTA, PROMESA_COMPRAVENTA, DONACION, etc.
  actoContrato            String?            // Mantenido para retrocompatibilidad
  
  // VALORES
  valorContrato           Decimal            @db.Decimal(12, 2)
  avaluoMunicipal         Decimal?           @db.Decimal(12, 2)
  multa                   Decimal?           @db.Decimal(12, 2) // Solo para PROMESA_COMPRAVENTA
  formasPago              Json?
  
  // UBICACIN DEL INMUEBLE (separado en campos individuales)
  ubicacionDescripcion    String?            @db.Text // Descripci贸n del lote/predio
  ubicacionParroquia      String?
  ubicacionCanton         String?            @default("QUITO")
  ubicacionProvincia      String?            @default("PICHINCHA")
  
  // CAMPOS LEGACY (mantener para compatibilidad)
  bienInmuebleDescripcion String?
  bienInmuebleUbicacion   String?
  
  // DATOS DE VEHCULO (para actas de reconocimiento)
  vehiculoAnio            String?
  vehiculoMarca           String?
  vehiculoModelo          String?
  vehiculoPlaca           String?
  vehiculoCiudadComercializacion String?      // Ciudad donde se comercializa
  
  // OTROS
  tipoActoOtro            String?
  
  // CACHE DE TEXTOS GENERADOS
  textoEncabezadoGenerado    String?         @db.Text
  textoComparecenciaGenerado String?         @db.Text
  fechaUltimaGeneracion      DateTime?
  
  // AUDITORA
  createdBy               Int
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  
  // RELACIONES
  personas                PersonaProtocolo[]
  creador                 User               @relation(fields: [createdBy], references: [id])

  @@index([numeroProtocolo])
  @@index([identificadorTemporal])
  @@index([tipoActo])
  @@index([createdBy])
  @@index([createdAt])
  @@map("protocolos_uafe")
}

model PersonaProtocolo {
  id                  String                 @id @default(uuid())
  protocoloId         String
  personaCedula       String
  
  // IDENTIFICACIN FLEXIBLE (para personas no registradas a煤n)
  nombreTemporal      String?                // Null si persona existe en BD
  
  // ROL EN ESTE TRMITE
  calidad             String                 // VENDEDOR, COMPRADOR, DONANTE, etc.
  actuaPor            String                 // PROPIOS_DERECHOS, REPRESENTANDO_SOCIEDAD_CONYUGAL, COMO_APODERADO
  
  // ESTADO DE COMPLETITUD (para sem谩foro 答○)
  estadoCompletitud   String                 @default("pendiente") // pendiente, incompleto, completo
  porcentajeCompletitud Int                  @default(0) // 0-100%
  camposFaltantes     Json?                  // Lista de campos que faltan para verde
  
  // CAMPOS PARA REDACCIN
  compareceConyugeJunto Boolean              @default(false) // Si comparece con su c贸nyuge
  esApoderado         Boolean                @default(false) // Si act煤a como apoderado
  mandanteCedula      String?                // C茅dula del mandante si es apoderado
  mandanteNombre      String?                // Nombre del mandante
  
  // ORDEN de aparici贸n en documentos
  orden               Int                    @default(0)
  
  // CAMPOS LEGACY
  completado          Boolean                @default(false)
  completadoAt        DateTime?
  respuestaFormulario Json?
  representadoId      String?
  datosRepresentado   Json?
  
  // TIMESTAMPS
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  
  // RELACIONES
  persona             PersonaRegistrada      @relation("Compareciente", fields: [personaCedula], references: [numeroIdentificacion])
  protocolo           ProtocoloUAFE          @relation(fields: [protocoloId], references: [id], onDelete: Cascade)
  representado        PersonaRegistrada?     @relation("Representado", fields: [representadoId], references: [numeroIdentificacion])
  sesiones            SesionFormularioUAFE[]

  @@unique([protocoloId, personaCedula])
  @@index([protocoloId])
  @@index([personaCedula])
  @@index([completado])
  @@index([estadoCompletitud])
  @@index([representadoId])
  @@map("personas_protocolo")
}

model SesionFormularioUAFE {
  id                 String           @id @default(uuid())
  personaProtocoloId String
  token              String           @unique
  expiraEn           DateTime
  ultimaActividad    DateTime         @default(now())
  ipAddress          String?
  userAgent          String?
  createdAt          DateTime         @default(now())
  personaProtocolo   PersonaProtocolo @relation(fields: [personaProtocoloId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([personaProtocoloId])
  @@index([expiraEn])
  @@map("sesiones_formulario_uafe")
}

model EncuestaSatisfaccion {
  id           Int      @id @default(autoincrement())
  createdAt    DateTime @default(now())
  tramiteId    String?  // ID proveniente de URL param (?ref=...)
  calificacion Int      // 1 a 5
  infoClara    Boolean
  tratoCordial Boolean
  sugerencia   String?  @db.Text

  @@index([createdAt])
  @@index([calificacion])
  @@map("encuestas_satisfaccion")
}

enum UserRole {
  ADMIN
  CAJA
  MATRIZADOR
  RECEPCION
  ARCHIVO
}

// ========================================
// MDULO DE FACTURACIN
// ========================================

model Invoice {
  id                String        @id @default(uuid())
  
  // Identificaci贸n (NICO)
  invoiceNumber     String        @unique  // numtra normalizado: 001-002-000123341
  invoiceNumberRaw  String                 // numtra original: 001002-00123341
  
  // Datos del cliente (desnormalizados del CSV, para facturas sin documento)
  clientTaxId       String                 // codcli (c茅dula/RUC)
  clientName        String                 // nomcli
  
  // Montos
  totalAmount       Decimal       @db.Decimal(12, 2)  // valcob de FC
  
  // Fechas
  issueDate         DateTime               // fecemi (en FC) o fectra (en AB para legacy)
  dueDate           DateTime?              // fecven
  
  // Referencia
  concept           String?                // concep
  
  // Estado y control
  status            InvoiceStatus @default(PENDING)
  isLegacy          Boolean       @default(false)  // Creada por pago hu茅rfano
  
  // Vinculaci贸n con documento notarial (autom谩tica por numeroFactura)
  documentId        String?
  document          Document?     @relation(fields: [documentId], references: [id])
  
  // Metadata de importaci贸n
  importedAt        DateTime      @default(now())
  lastSyncAt        DateTime      @updatedAt
  sourceFile        String?                // Nombre del archivo de origen
  
  // Relaciones
  payments          Payment[]
  
  @@map("invoices")
  @@index([invoiceNumber])
  @@index([clientTaxId])
  @@index([status])
  @@index([issueDate])
  @@index([documentId])
}

model Payment {
  id              String      @id @default(uuid())
  
  // Identificaci贸n (NICO)
  receiptNumber   String      @unique  // numdoc: 001-2601000089
  
  // Monto
  amount          Decimal     @db.Decimal(12, 2)  // valcob de AB
  
  // Fechas
  paymentDate     DateTime               // fecemi
  
  // Referencias
  concept         String?                // concep (ej: "PAGO FACT 119478 05/09")
  accountingRef   String?                // numcco (comprobante contable)
  
  // Tipo de pago
  paymentType     PaymentType @default(CASH)
  
  // Factura asociada
  invoiceId       String
  invoice         Invoice     @relation(fields: [invoiceId], references: [id])
  
  // Metadata
  importedAt      DateTime    @default(now())
  sourceFile      String?
  
  @@map("payments")
  @@index([receiptNumber])
  @@index([invoiceId])
  @@index([paymentDate])
}

model ImportLog {
  id              String       @id @default(uuid())
  
  // Informaci贸n del archivo
  fileName        String
  fileType        String               // 'POR_COBRAR' o 'CXC'
  
  // Estad铆sticas
  totalRows       Int
  invoicesCreated Int          @default(0)
  invoicesUpdated Int          @default(0)
  paymentsCreated Int          @default(0)
  paymentsSkipped Int          @default(0)
  errors          Int          @default(0)
  
  // Rango de fechas procesado
  dateFrom        DateTime?
  dateTo          DateTime?
  
  // Estado
  status          ImportStatus @default(PROCESSING)
  errorDetails    Json?
  
  // Usuario que ejecut贸
  executedBy      Int?
  executedByUser  User?        @relation(fields: [executedBy], references: [id])
  
  // Timestamps
  startedAt       DateTime     @default(now())
  completedAt     DateTime?
  
  @@map("import_logs")
  @@index([status])
  @@index([startedAt])
}

enum InvoiceStatus {
  PENDING       // Pendiente de pago
  PARTIAL       // Pago parcial
  PAID          // Pagada completamente
  OVERDUE       // Vencida
  CANCELLED     // Anulada
}

enum PaymentType {
  CASH          // Efectivo
  TRANSFER      // Transferencia
  CHECK         // Cheque
  RETENTION     // Retenci贸n
  CREDIT_NOTE   // Nota de cr茅dito
  OTHER         // Otro
}

enum ImportStatus {
  PROCESSING
  COMPLETED
  COMPLETED_WITH_ERRORS
  FAILED
}
