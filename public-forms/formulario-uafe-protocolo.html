<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario UAFE - Notar√≠a 18 Quito</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 22px;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="email"],
        input[type="tel"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        input:readonly {
            background-color: #f5f5f5;
            color: #666;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #d0d0d0;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 8px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .progress-bar-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.active {
            display: block;
        }

        .alert-error {
            background: #fee;
            color: #c00;
            border: 1px solid #fcc;
        }

        .alert-success {
            background: #efe;
            color: #060;
            border: 1px solid #cfc;
        }

        .alert-info {
            background: #eef;
            color: #006;
            border: 1px solid #ccf;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .subsection {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .subsection-title {
            font-size: 18px;
            color: #764ba2;
            margin-bottom: 15px;
        }

        .info-box {
            background: #f0f7ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .info-box strong {
            color: #667eea;
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
        }

        .required {
            color: red;
        }

        .helper-text {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-option input[type="radio"] {
            width: auto;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Formulario UAFE</h1>
            <p>Notar√≠a D√©cima Octava del Cant√≥n Quito</p>
        </div>

        <div class="content">
            <!-- SECCI√ìN DE LOGIN -->
            <div id="loginSection" class="section active">
                <h2 class="section-title">Acceso al Formulario</h2>

                <div class="info-box">
                    <p><strong>Instrucciones:</strong></p>
                    <p>Para acceder al formulario necesitas 3 datos:</p>
                    <ol style="margin-left: 20px; margin-top: 10px;">
                        <li>N√∫mero de Protocolo (proporcionado por la notar√≠a)</li>
                        <li>Tu n√∫mero de c√©dula</li>
                        <li>Tu PIN de 6 d√≠gitos (configurado al registrarte)</li>
                    </ol>
                </div>

                <div id="loginAlert" class="alert"></div>

                <form onsubmit="event.preventDefault(); login();">
                    <div class="form-group">
                        <label for="loginProtocolo">N√∫mero de Protocolo <span class="required">*</span></label>
                        <input
                            type="text"
                            id="loginProtocolo"
                            placeholder="Ej: 2024-1234"
                            required
                        >
                        <div class="helper-text">N√∫mero proporcionado por la notar√≠a</div>
                    </div>

                    <div class="form-group">
                        <label for="loginCedula">N√∫mero de C√©dula <span class="required">*</span></label>
                        <input
                            type="text"
                            id="loginCedula"
                            placeholder="Ej: 1234567890"
                            maxlength="13"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="loginPin">PIN <span class="required">*</span></label>
                        <input
                            type="password"
                            id="loginPin"
                            placeholder="6 d√≠gitos"
                            maxlength="6"
                            required
                        >
                        <div class="helper-text">PIN de 6 d√≠gitos configurado al registrarte</div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="loginBtn">
                        Ingresar al Formulario
                    </button>
                </form>

                <div id="loginLoading" class="loading">
                    <div class="spinner"></div>
                    <p style="color: #666;">Verificando credenciales...</p>
                </div>
            </div>

            <!-- SECCI√ìN DE FORMULARIO -->
            <div id="formularioSection" class="section">
                <div class="progress-bar">
                    <div class="progress-bar-fill" id="progressBar"></div>
                </div>

                <div id="formAlert" class="alert"></div>

                <!-- Informaci√≥n del Protocolo -->
                <div id="protocoloInfo" class="info-box"></div>

                <!-- Secci√≥n 1: Datos Personales -->
                <div id="seccion1" class="form-section active">
                    <h2 class="section-title">1. Datos de Identificaci√≥n</h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de Identificaci√≥n <span class="required">*</span></label>
                            <select id="tipoIdentificacion" required>
                                <option value="">Seleccione...</option>
                                <option value="CEDULA">C√©dula</option>
                                <option value="RUC">RUC</option>
                                <option value="PASAPORTE">Pasaporte</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>N√∫mero de Identificaci√≥n</label>
                            <input type="text" id="numeroIdentificacion" readonly>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Apellidos <span class="required">*</span></label>
                            <input type="text" id="apellidos" required>
                        </div>
                        <div class="form-group">
                            <label>Nombres <span class="required">*</span></label>
                            <input type="text" id="nombres" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Nacionalidad <span class="required">*</span></label>
                            <input type="text" id="nacionalidad" required placeholder="Ej: Ecuatoriana">
                        </div>
                        <div class="form-group">
                            <label>G√©nero <span class="required">*</span></label>
                            <select id="genero" required>
                                <option value="">Seleccione...</option>
                                <option value="MASCULINO">Masculino</option>
                                <option value="FEMENINO">Femenino</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Estado Civil <span class="required">*</span></label>
                            <select id="estadoCivil" required onchange="toggleConyugeSection()">
                                <option value="">Seleccione...</option>
                                <option value="SOLTERO">Soltero/a</option>
                                <option value="CASADO">Casado/a</option>
                                <option value="UNION_LIBRE">Uni√≥n Libre</option>
                                <option value="DIVORCIADO">Divorciado/a</option>
                                <option value="VIUDO">Viudo/a</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nivel de Estudio <span class="required">*</span></label>
                            <select id="nivelEstudio" required>
                                <option value="">Seleccione...</option>
                                <option value="BACHILLER">Bachiller</option>
                                <option value="UNIVERSITARIO">Universitario</option>
                                <option value="MAESTRIA">Maestr√≠a</option>
                                <option value="POSTGRADO">Postgrado</option>
                            </select>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="cerrarSesion()">Salir</button>
                        <button class="btn btn-primary" onclick="siguienteSeccion()">Siguiente ‚Üí</button>
                    </div>
                </div>

                <!-- Secci√≥n 2: Contacto y Direcci√≥n -->
                <div id="seccion2" class="form-section">
                    <h2 class="section-title">2. Datos de Contacto y Direcci√≥n</h2>

                    <div class="subsection">
                        <div class="subsection-title">Contacto</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Correo Electr√≥nico <span class="required">*</span></label>
                                <input type="email" id="email" required>
                            </div>
                            <div class="form-group">
                                <label>Tel√©fono</label>
                                <input type="tel" id="telefono">
                            </div>
                            <div class="form-group">
                                <label>Celular <span class="required">*</span></label>
                                <input type="tel" id="celular" required>
                            </div>
                        </div>
                    </div>

                    <div class="subsection">
                        <div class="subsection-title">Direcci√≥n Domiciliaria</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Calle Principal <span class="required">*</span></label>
                                <input type="text" id="callePrincipal" required>
                            </div>
                            <div class="form-group">
                                <label>N√∫mero</label>
                                <input type="text" id="numeroDomicilio">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Calle Secundaria</label>
                            <input type="text" id="calleSecundaria">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Provincia <span class="required">*</span></label>
                                <input type="text" id="provincia" required>
                            </div>
                            <div class="form-group">
                                <label>Cant√≥n <span class="required">*</span></label>
                                <input type="text" id="canton" required>
                            </div>
                            <div class="form-group">
                                <label>Parroquia <span class="required">*</span></label>
                                <input type="text" id="parroquia" required>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="anteriorSeccion()">‚Üê Anterior</button>
                        <button class="btn btn-primary" onclick="siguienteSeccion()">Siguiente ‚Üí</button>
                    </div>
                </div>

                <!-- Secci√≥n 3: Informaci√≥n Laboral -->
                <div id="seccion3" class="form-section">
                    <h2 class="section-title">3. Informaci√≥n Laboral</h2>

                    <div class="form-group">
                        <label>Situaci√≥n Laboral <span class="required">*</span></label>
                        <select id="situacionLaboral" required onchange="toggleInfoLaboral()">
                            <option value="">Seleccione...</option>
                            <option value="PUBLICO">P√∫blico</option>
                            <option value="PRIVADO">Privado</option>
                            <option value="JUBILADO">Jubilado</option>
                            <option value="NO_APLICA">No Aplica</option>
                        </select>
                    </div>

                    <div id="detalleLaboral" class="hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Relaci√≥n de Dependencia</label>
                                <div class="radio-group">
                                    <div class="radio-option">
                                        <input type="radio" name="relacionDependencia" id="relacionSi" value="true">
                                        <label for="relacionSi">S√≠</label>
                                    </div>
                                    <div class="radio-option">
                                        <input type="radio" name="relacionDependencia" id="relacionNo" value="false">
                                        <label for="relacionNo">No</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Fecha de Ingreso</label>
                                <input type="date" id="fechaIngreso">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Nombre de la Entidad</label>
                            <input type="text" id="nombreEntidad">
                        </div>

                        <div class="form-group">
                            <label>Direcci√≥n de la Entidad</label>
                            <input type="text" id="direccionEntidad">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Provincia</label>
                                <input type="text" id="provinciaEntidad">
                            </div>
                            <div class="form-group">
                                <label>Cant√≥n</label>
                                <input type="text" id="cantonEntidad">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Profesi√≥n / Ocupaci√≥n <span class="required">*</span></label>
                                <input type="text" id="profesionOcupacion" required>
                            </div>
                            <div class="form-group">
                                <label>Cargo</label>
                                <input type="text" id="cargo">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Ingreso Mensual ($) <span class="required">*</span></label>
                            <input type="number" id="ingresoMensual" step="0.01" placeholder="0.00" required>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="anteriorSeccion()">‚Üê Anterior</button>
                        <button class="btn btn-primary" onclick="siguienteSeccion()">Siguiente ‚Üí</button>
                    </div>
                </div>

                <!-- Secci√≥n 4: Datos del C√≥nyuge (condicional) -->
                <div id="seccion4" class="form-section">
                    <h2 class="section-title">4. Datos del C√≥nyuge</h2>

                    <div class="alert alert-info active">
                        Esta secci√≥n solo se completa si est√° casado o en uni√≥n libre
                    </div>

                    <div id="conyugeForm" class="hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Apellidos</label>
                                <input type="text" id="conyugeApellidos">
                            </div>
                            <div class="form-group">
                                <label>Nombres</label>
                                <input type="text" id="conyugeNombres">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Tipo de Identificaci√≥n</label>
                                <select id="conyugeTipoId">
                                    <option value="">Seleccione...</option>
                                    <option value="CEDULA">C√©dula</option>
                                    <option value="RUC">RUC</option>
                                    <option value="PASAPORTE">Pasaporte</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>N√∫mero de Identificaci√≥n</label>
                                <input type="text" id="conyugeNumeroId">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Nacionalidad</label>
                                <input type="text" id="conyugeNacionalidad">
                            </div>
                            <div class="form-group">
                                <label>Profesi√≥n</label>
                                <input type="text" id="conyugeProfesion">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Situaci√≥n Laboral</label>
                                <select id="conyugeSituacionLaboral">
                                    <option value="">Seleccione...</option>
                                    <option value="EMPLEADO_PUBLICO">Empleado P√∫blico</option>
                                    <option value="EMPLEADO_PRIVADO">Empleado Privado</option>
                                    <option value="INDEPENDIENTE">Independiente/Profesional</option>
                                    <option value="COMERCIANTE">Comerciante</option>
                                    <option value="JUBILADO">Jubilado/Pensionado</option>
                                    <option value="AMA_DE_CASA">Ama de Casa</option>
                                    <option value="ESTUDIANTE">Estudiante</option>
                                    <option value="DESEMPLEADO">Desempleado</option>
                                    <option value="OTRO">Otro</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Correo Electr√≥nico</label>
                                <input type="email" id="conyugeEmail">
                            </div>
                            <div class="form-group">
                                <label>Celular</label>
                                <input type="tel" id="conyugeCelular">
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="anteriorSeccion()">‚Üê Anterior</button>
                        <button class="btn btn-primary" onclick="siguienteSeccion()">Siguiente ‚Üí</button>
                    </div>
                </div>

                <!-- Secci√≥n 5: PEP (Personas Expuestas Pol√≠ticamente) -->
                <div id="seccion5" class="form-section">
                    <h2 class="section-title">5. Personas Expuestas Pol√≠ticamente (PEP)</h2>

                    <div class="alert alert-info active">
                        Por favor responda con veracidad las siguientes preguntas
                    </div>

                    <div class="form-group">
                        <label>¬øSe considera una persona expuesta pol√≠ticamente (PEP)?</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" name="esPersonaExpuesta" id="pepSi" value="true">
                                <label for="pepSi">S√≠</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="esPersonaExpuesta" id="pepNo" value="false" checked>
                                <label for="pepNo">No</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>¬øEs familiar de un PEP?</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" name="esFamiliarPEP" id="familiarPepSi" value="true">
                                <label for="familiarPepSi">S√≠</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="esFamiliarPEP" id="familiarPepNo" value="false" checked>
                                <label for="familiarPepNo">No</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>¬øEs colaborador cercano de un PEP?</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" name="esColaboradorPEP" id="colaboradorPepSi" value="true">
                                <label for="colaboradorPepSi">S√≠</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="esColaboradorPEP" id="colaboradorPepNo" value="false" checked>
                                <label for="colaboradorPepNo">No</label>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="anteriorSeccion()">‚Üê Anterior</button>
                        <button class="btn btn-primary" onclick="enviarFormulario()">Enviar Formulario ‚úì</button>
                    </div>
                </div>

                <!-- Secci√≥n de Confirmaci√≥n -->
                <div id="seccionConfirmacion" class="form-section">
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 80px; color: #4caf50;">‚úì</div>
                        <h2 style="color: #4caf50; margin: 20px 0;">¬°Formulario Enviado Exitosamente!</h2>
                        <p style="font-size: 18px; color: #666; margin-bottom: 30px;">
                            Gracias por completar el formulario UAFE. Los datos han sido registrados correctamente.
                        </p>
                        <button class="btn btn-primary" onclick="location.reload()">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading -->
            <div id="loadingSection" class="loading">
                <div class="spinner"></div>
                <p style="color: #666;">Procesando...</p>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURACI√ìN
        // ========================================
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3000/api'
            : 'https://notaria-segura-v4-production.up.railway.app/api';

        let sessionToken = null;
        let sessionData = null;
        let seccionActual = 1;
        const totalSecciones = 5;

        // ========================================
        // FUNCIONES DE UI
        // ========================================
        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            alert.className = `alert alert-${type} active`;
            alert.textContent = message;

            setTimeout(() => {
                alert.classList.remove('active');
            }, 5000);
        }

        function showLoading(show) {
            const loading = document.getElementById('loadingSection');
            const loginLoading = document.getElementById('loginLoading');

            if (show) {
                if (loginLoading) loginLoading.classList.add('active');
                loading.classList.add('active');
            } else {
                if (loginLoading) loginLoading.classList.remove('active');
                loading.classList.remove('active');
            }
        }

        function mostrarSeccion(seccionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(seccionId).classList.add('active');
        }

        function actualizarProgreso() {
            const progreso = (seccionActual / totalSecciones) * 100;
            document.getElementById('progressBar').style.width = `${progreso}%`;
        }

        // ========================================
        // LOGIN
        // ========================================
        async function login() {
            const numeroProtocolo = document.getElementById('loginProtocolo').value.trim();
            const cedula = document.getElementById('loginCedula').value.trim();
            const pin = document.getElementById('loginPin').value.trim();

            if (!numeroProtocolo || !cedula || !pin) {
                showAlert('loginAlert', 'Por favor complete todos los campos', 'error');
                return;
            }

            if (pin.length !== 6) {
                showAlert('loginAlert', 'El PIN debe tener 6 d√≠gitos', 'error');
                return;
            }

            showLoading(true);

            try {
                const response = await fetch(`${API_URL}/formulario-uafe/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        numeroProtocolo: numeroProtocolo,
                        cedula: cedula,
                        pin: pin
                    })
                });

                const data = await response.json();

                if (data.success) {
                    sessionToken = data.sessionToken;
                    sessionData = data.data;

                    // Guardar en sessionStorage
                    sessionStorage.setItem('uafe-session-token', sessionToken);
                    sessionStorage.setItem('uafe-session-data', JSON.stringify(sessionData));

                    mostrarDatosProtocolo();
                    precargarDatos();
                    mostrarSeccion('formularioSection');
                    actualizarProgreso();
                } else {
                    showAlert('loginAlert', data.message || 'Error al iniciar sesi√≥n', 'error');
                }
            } catch (error) {
                console.error('Error login:', error);
                showAlert('loginAlert', 'Error de conexi√≥n. Verifica tu internet e intenta nuevamente.', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ========================================
        // MOSTRAR DATOS DEL PROTOCOLO
        // ========================================
        function mostrarDatosProtocolo() {
            if (!sessionData) return;

            const infoBox = document.getElementById('protocoloInfo');
            const protocolo = sessionData.protocolo;
            const rol = sessionData.tuRol;

            infoBox.innerHTML = `
                <p><strong>Informaci√≥n del Tr√°mite:</strong></p>
                <p style="margin-top: 10px;">
                    <strong>Protocolo:</strong> ${protocolo.numeroProtocolo}<br>
                    <strong>Fecha:</strong> ${new Date(protocolo.fecha).toLocaleDateString('es-EC')}<br>
                    <strong>Acto/Contrato:</strong> ${protocolo.actoContrato}<br>
                    <strong>Valor:</strong> $${parseFloat(protocolo.valorContrato).toFixed(2)}
                </p>
                <p style="margin-top: 10px;">
                    <strong>Tu Rol:</strong> ${rol.calidad} - ${rol.actuaPor}
                </p>
            `;
        }

        // ========================================
        // PRE-CARGAR DATOS
        // ========================================
        function precargarDatos() {
            if (!sessionData || !sessionData.tusDatos) {
                console.log('No hay datos previos para pre-llenar');
                return;
            }

            const datos = sessionData.tusDatos;
            console.log('Pre-llenando datos:', datos);

            // Helper para setear valores
            function setValue(fieldId, value) {
                const field = document.getElementById(fieldId);
                if (field && value !== null && value !== undefined) {
                    field.value = value;
                }
            }

            // 1. Identificaci√≥n
            if (datos.identificacion) {
                setValue('tipoIdentificacion', datos.identificacion.tipo);
                setValue('numeroIdentificacion', datos.identificacion.numero);
                setValue('nacionalidad', datos.identificacion.nacionalidad);
            }

            // 2. Datos Personales
            if (datos.datosPersonales) {
                setValue('apellidos', datos.datosPersonales.apellidos);
                setValue('nombres', datos.datosPersonales.nombres);
                setValue('genero', datos.datosPersonales.genero);
                setValue('estadoCivil', datos.datosPersonales.estadoCivil);
                setValue('nivelEstudio', datos.datosPersonales.nivelEstudio);
                toggleConyugeSection(); // Activar secci√≥n de c√≥nyuge si aplica
            }

            // 3. Contacto
            if (datos.contacto) {
                setValue('email', datos.contacto.email);
                setValue('telefono', datos.contacto.telefono);
                setValue('celular', datos.contacto.celular);
            }

            // 4. Direcci√≥n
            if (datos.direccion) {
                setValue('callePrincipal', datos.direccion.callePrincipal);
                setValue('numeroDomicilio', datos.direccion.numero);
                setValue('calleSecundaria', datos.direccion.calleSecundaria);
                setValue('provincia', datos.direccion.provincia);
                setValue('canton', datos.direccion.canton);
                setValue('parroquia', datos.direccion.parroquia);
            }

            // 5. Informaci√≥n Laboral
            if (datos.informacionLaboral) {
                setValue('situacionLaboral', datos.informacionLaboral.situacion);
                toggleInfoLaboral(); // Mostrar campos laborales si aplica

                if (datos.informacionLaboral.relacionDependencia !== undefined) {
                    const relacionVal = datos.informacionLaboral.relacionDependencia;
                    if (relacionVal === true || relacionVal === 'true') {
                        document.getElementById('relacionSi').checked = true;
                    } else {
                        document.getElementById('relacionNo').checked = true;
                    }
                }

                setValue('fechaIngreso', datos.informacionLaboral.fechaIngreso);
                setValue('nombreEntidad', datos.informacionLaboral.nombreEntidad);
                setValue('direccionEntidad', datos.informacionLaboral.direccionEmpresa);
                setValue('provinciaEntidad', datos.informacionLaboral.provincia);
                setValue('cantonEntidad', datos.informacionLaboral.canton);
                setValue('profesionOcupacion', datos.informacionLaboral.profesionOcupacion);
                setValue('cargo', datos.informacionLaboral.cargo);
                setValue('ingresoMensual', datos.informacionLaboral.ingresoMensual);
            }

            // 6. C√≥nyuge (si aplica)
            if (datos.conyuge) {
                setValue('conyugeApellidos', datos.conyuge.apellidos);
                setValue('conyugeNombres', datos.conyuge.nombres);
                setValue('conyugeTipoId', datos.conyuge.tipoIdentificacion);
                setValue('conyugeNumeroId', datos.conyuge.numeroIdentificacion);
                setValue('conyugeNacionalidad', datos.conyuge.nacionalidad);
                setValue('conyugeProfesion', datos.conyuge.profesion);
                setValue('conyugeSituacionLaboral', datos.conyuge.situacionLaboral);
                setValue('conyugeEmail', datos.conyuge.email);
                setValue('conyugeCelular', datos.conyuge.celular);
            }

            // 7. PEP
            if (datos.pep) {
                if (datos.pep.esPersonaExpuesta !== undefined) {
                    const pepVal = datos.pep.esPersonaExpuesta;
                    if (pepVal === true || pepVal === 'true') {
                        document.getElementById('pepSi').checked = true;
                    } else {
                        document.getElementById('pepNo').checked = true;
                    }
                }

                if (datos.pep.esFamiliarPEP !== undefined) {
                    const familiarVal = datos.pep.esFamiliarPEP;
                    if (familiarVal === true || familiarVal === 'true') {
                        document.getElementById('familiarPepSi').checked = true;
                    } else {
                        document.getElementById('familiarPepNo').checked = true;
                    }
                }

                if (datos.pep.esColaboradorPEP !== undefined) {
                    const colaboradorVal = datos.pep.esColaboradorPEP;
                    if (colaboradorVal === true || colaboradorVal === 'true') {
                        document.getElementById('colaboradorPepSi').checked = true;
                    } else {
                        document.getElementById('colaboradorPepNo').checked = true;
                    }
                }
            }

            console.log('Datos pre-llenados exitosamente');
        }

        // ========================================
        // NAVEGACI√ìN ENTRE SECCIONES
        // ========================================
        function siguienteSeccion() {
            if (!validarSeccionActual()) return;

            if (seccionActual < totalSecciones) {
                document.getElementById(`seccion${seccionActual}`).classList.remove('active');
                seccionActual++;
                document.getElementById(`seccion${seccionActual}`).classList.add('active');
                actualizarProgreso();
                window.scrollTo(0, 0);
            }
        }

        function anteriorSeccion() {
            if (seccionActual > 1) {
                document.getElementById(`seccion${seccionActual}`).classList.remove('active');
                seccionActual--;
                document.getElementById(`seccion${seccionActual}`).classList.add('active');
                actualizarProgreso();
                window.scrollTo(0, 0);
            }
        }

        function validarSeccionActual() {
            const seccion = document.getElementById(`seccion${seccionActual}`);
            const required = seccion.querySelectorAll('[required]');

            for (let field of required) {
                if (!field.value.trim()) {
                    showAlert('formAlert', 'Por favor complete todos los campos obligatorios (*)', 'error');
                    field.focus();
                    return false;
                }
            }

            return true;
        }

        // ========================================
        // TOGGLES
        // ========================================
        function toggleConyugeSection() {
            const estadoCivil = document.getElementById('estadoCivil').value;
            const conyugeForm = document.getElementById('conyugeForm');
            const mostrar = estadoCivil === 'CASADO' || estadoCivil === 'UNION_LIBRE';
            conyugeForm.classList.toggle('hidden', !mostrar);
        }

        function toggleInfoLaboral() {
            const situacion = document.getElementById('situacionLaboral').value;
            const detalle = document.getElementById('detalleLaboral');
            detalle.classList.toggle('hidden', situacion === 'NO_APLICA' || !situacion);
        }

        // ========================================
        // ENVIAR FORMULARIO
        // ========================================
        async function enviarFormulario() {
            if (!validarSeccionActual()) return;

            if (!sessionToken) {
                showAlert('formAlert', 'Sesi√≥n expirada. Por favor inicia sesi√≥n nuevamente.', 'error');
                return;
            }

            showLoading(true);

            try {
                const estadoCivil = document.getElementById('estadoCivil').value;
                const tieneConyugue = estadoCivil === 'CASADO' || estadoCivil === 'UNION_LIBRE';

                // Construir objeto de datos actualizado
                const datosActualizados = {
                    identificacion: {
                        tipo: document.getElementById('tipoIdentificacion').value,
                        numero: document.getElementById('numeroIdentificacion').value,
                        nacionalidad: document.getElementById('nacionalidad').value
                    },
                    datosPersonales: {
                        apellidos: document.getElementById('apellidos').value,
                        nombres: document.getElementById('nombres').value,
                        genero: document.getElementById('genero').value,
                        estadoCivil: estadoCivil,
                        nivelEstudio: document.getElementById('nivelEstudio').value
                    },
                    contacto: {
                        email: document.getElementById('email').value,
                        telefono: document.getElementById('telefono').value || null,
                        celular: document.getElementById('celular').value
                    },
                    direccion: {
                        callePrincipal: document.getElementById('callePrincipal').value,
                        numero: document.getElementById('numeroDomicilio').value || null,
                        calleSecundaria: document.getElementById('calleSecundaria').value || null,
                        provincia: document.getElementById('provincia').value,
                        canton: document.getElementById('canton').value,
                        parroquia: document.getElementById('parroquia').value
                    },
                    informacionLaboral: {
                        situacion: document.getElementById('situacionLaboral').value,
                        relacionDependencia: document.querySelector('input[name="relacionDependencia"]:checked')?.value === 'true' || false,
                        fechaIngreso: document.getElementById('fechaIngreso').value || null,
                        nombreEntidad: document.getElementById('nombreEntidad').value || null,
                        direccionEmpresa: document.getElementById('direccionEntidad').value || null,
                        provincia: document.getElementById('provinciaEntidad').value || null,
                        canton: document.getElementById('cantonEntidad').value || null,
                        profesionOcupacion: document.getElementById('profesionOcupacion').value,
                        cargo: document.getElementById('cargo').value || null,
                        ingresoMensual: parseFloat(document.getElementById('ingresoMensual').value) || null
                    },
                    conyuge: tieneConyugue ? {
                        apellidos: document.getElementById('conyugeApellidos').value || null,
                        nombres: document.getElementById('conyugeNombres').value || null,
                        tipoIdentificacion: document.getElementById('conyugeTipoId').value || null,
                        numeroIdentificacion: document.getElementById('conyugeNumeroId').value || null,
                        nacionalidad: document.getElementById('conyugeNacionalidad').value || null,
                        profesion: document.getElementById('conyugeProfesion').value || null,
                        situacionLaboral: document.getElementById('conyugeSituacionLaboral').value || null,
                        email: document.getElementById('conyugeEmail').value || null,
                        celular: document.getElementById('conyugeCelular').value || null
                    } : null,
                    pep: {
                        esPersonaExpuesta: document.querySelector('input[name="esPersonaExpuesta"]:checked').value === 'true',
                        esFamiliarPEP: document.querySelector('input[name="esFamiliarPEP"]:checked').value === 'true',
                        esColaboradorPEP: document.querySelector('input[name="esColaboradorPEP"]:checked').value === 'true'
                    }
                };

                const response = await fetch(`${API_URL}/formulario-uafe/responder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-session-token': sessionToken
                    },
                    body: JSON.stringify({ datosPersonaNatural: datosActualizados })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('seccion5').classList.remove('active');
                    document.getElementById('seccionConfirmacion').classList.add('active');
                } else {
                    showAlert('formAlert', data.message || 'Error al enviar formulario', 'error');
                }
            } catch (error) {
                console.error('Error enviando formulario:', error);
                showAlert('formAlert', 'Error de conexi√≥n al enviar', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ========================================
        // CERRAR SESI√ìN
        // ========================================
        function cerrarSesion() {
            if (confirm('¬øEst√° seguro de salir? Los cambios no guardados se perder√°n.')) {
                sessionToken = null;
                sessionData = null;
                seccionActual = 1;
                sessionStorage.removeItem('uafe-session-token');
                sessionStorage.removeItem('uafe-session-data');
                location.reload();
            }
        }

        // ========================================
        // INICIALIZACI√ìN
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Formulario UAFE - Sistema de Protocolos');
            console.log('API URL:', API_URL);

            // Restaurar sesi√≥n si existe
            const savedToken = sessionStorage.getItem('uafe-session-token');
            const savedData = sessionStorage.getItem('uafe-session-data');

            if (savedToken && savedData) {
                sessionToken = savedToken;
                sessionData = JSON.parse(savedData);
                mostrarDatosProtocolo();
                precargarDatos();
                mostrarSeccion('formularioSection');
                actualizarProgreso();
            }
        });
    </script>
</body>
</html>
